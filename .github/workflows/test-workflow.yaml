name: Test Multilspy

on:
  push:
    branches: [main, feat/*]
  pull_request:

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # First, run a quick sanity check with Python tests only
  test-python:
    name: Test Python Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Python LSP tests
        run: |
          pytest tests/multilspy/test_multilspy_python.py tests/multilspy/test_sync_multilspy_python.py -v --tb=short

  # Test Go language server
  test-go:
    name: Test Go Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Install gopls
        run: go install golang.org/x/tools/gopls@latest

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Go LSP tests
        run: |
          pytest tests/multilspy/test_multilspy_go.py -v --tb=short

  # Test Ruby language server (Solargraph)
  test-ruby:
    name: Test Ruby Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"

      - name: Install Solargraph
        run: gem install solargraph

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Ruby LSP tests
        run: |
          pytest tests/multilspy/test_multilspy_ruby.py tests/multilspy/test_sync_multilspy_ruby.py -v --tb=short

  # Test TypeScript/JavaScript language server
  test-typescript:
    name: Test TypeScript/JavaScript Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run TypeScript LSP tests
        run: |
          pytest tests/multilspy/test_multilspy_typescript.py tests/multilspy/test_sync_multilspy_typescript.py -v --tb=short

      - name: Run JavaScript LSP tests
        run: |
          pytest tests/multilspy/test_multilspy_javascript.py tests/multilspy/test_sync_multilspy_javascript.py -v --tb=short

  # Test Rust language server (rust-analyzer)
  test-rust:
    name: Test Rust Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Rust LSP tests
        run: |
          pytest tests/multilspy/test_multilspy_rust.py tests/multilspy/test_sync_multilspy_rust.py -v --tb=short

  # Test Java language server (Eclipse JDT.LS)
  test-java:
    name: Test Java Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Java LSP tests
        run: |
          pytest tests/multilspy/test_multilspy_java.py tests/multilspy/test_sync_multilspy_java.py -v --tb=short

  # Test Kotlin language server
  test-kotlin:
    name: Test Kotlin Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Kotlin LSP tests
        run: |
          pytest tests/multilspy/test_multilspy_kotlin.py tests/multilspy/test_sync_multilspy_kotlin.py -v --tb=short

  # Test Dart language server
  test-dart:
    name: Test Dart Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Dart LSP tests
        run: |
          pytest tests/multilspy/test_multilspy_dart.py tests/multilspy/test_sync_multilspy_dart.py -v --tb=short

  # Test C/C++ language server (clangd)
  test-clangd:
    name: Test C/C++ Language Server (clangd)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run clangd LSP tests
        run: |
          pytest tests/multilspy/test_multilspy_clangd.py -v --tb=short

  # Test C# language server (OmniSharp) - currently skipped in tests
  # test-csharp:
  #   name: Test C# Language Server
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Set up .NET
  #       uses: actions/setup-dotnet@v4
  #       with:
  #         dotnet-version: "8.0.x"
  #
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: "3.11"
  #         cache: "pip"
  #
  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -r requirements.txt
  #         pip install -e .
  #
  #     - name: Run C# LSP tests
  #       run: |
  #         pytest tests/multilspy/test_multilspy_csharp.py tests/multilspy/test_sync_multilspy_csharp.py -v --tb=short

  # Test sync timeout functionality
  test-sync-timeout:
    name: Test Sync Timeout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run sync timeout tests
        run: |
          pytest tests/multilspy/test_sync_multilspy_timeout.py -v --tb=short

  # Final job to check all tests passed
  all-tests-passed:
    name: All Tests Passed
    needs:
      - test-python
      - test-go
      - test-ruby
      - test-typescript
      - test-rust
      - test-java
      - test-kotlin
      - test-dart
      - test-clangd
      - test-sync-timeout
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all tests passed
        run: |
          if [[ "${{ needs.test-python.result }}" != "success" ]] || \
             [[ "${{ needs.test-go.result }}" != "success" ]] || \
             [[ "${{ needs.test-ruby.result }}" != "success" ]] || \
             [[ "${{ needs.test-typescript.result }}" != "success" ]] || \
             [[ "${{ needs.test-rust.result }}" != "success" ]] || \
             [[ "${{ needs.test-java.result }}" != "success" ]] || \
             [[ "${{ needs.test-kotlin.result }}" != "success" ]] || \
             [[ "${{ needs.test-dart.result }}" != "success" ]] || \
             [[ "${{ needs.test-clangd.result }}" != "success" ]] || \
             [[ "${{ needs.test-sync-timeout.result }}" != "success" ]]; then
            echo "One or more test jobs failed!"
            exit 1
          fi
          echo "All tests passed!"
