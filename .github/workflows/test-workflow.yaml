name: Test Multilspy

on:
  push:
    branches: [main, feat/*]
  pull_request:

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Test Python language server (jedi-language-server)
  test-python:
    name: Test Python Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Python LSP tests
        run: |
          pytest tests/multilspy/test_*python*.py -v --tb=short

  # Test Go language server (gopls)
  test-go:
    name: Test Go Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Install gopls
        run: go install golang.org/x/tools/gopls@latest

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Go LSP tests
        run: |
          pytest tests/multilspy/test_*go*.py -v --tb=short

  # Test Ruby language server (Solargraph)
  test-ruby:
    name: Test Ruby Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"

      - name: Install Solargraph
        run: gem install solargraph

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Ruby LSP tests
        run: |
          pytest tests/multilspy/test_*ruby*.py -v --tb=short

  # Test TypeScript/JavaScript language server
  test-typescript-javascript:
    name: Test TypeScript/JavaScript Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run TypeScript and JavaScript LSP tests
        run: |
          pytest tests/multilspy/test_*typescript*.py tests/multilspy/test_*javascript*.py -v --tb=short

  # Test Rust language server (rust-analyzer)
  test-rust:
    name: Test Rust Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Rust LSP tests
        run: |
          pytest tests/multilspy/test_*rust*.py -v --tb=short

  # Test Java language server (Eclipse JDT.LS)
  test-java:
    name: Test Java Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # Remove problematic JDK installations that Eclipse JDT.LS tries to detect
      # These have permission issues and cause JDT.LS initialization to fail
      - name: Remove problematic JDK installations
        run: |
          sudo rm -rf /usr/lib/jvm/temurin-8-jdk-amd64 || true
          sudo rm -rf /usr/lib/jvm/adoptopenjdk-8-hotspot-amd64 || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Java LSP tests
        run: |
          pytest tests/multilspy/test_*java*.py -v --tb=short

  # Test Kotlin language server
  test-kotlin:
    name: Test Kotlin Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Kotlin LSP tests
        run: |
          pytest tests/multilspy/test_*kotlin*.py -v --tb=short

  # Test Dart language server
  test-dart:
    name: Test Dart Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run Dart LSP tests
        run: |
          pytest tests/multilspy/test_*dart*.py -v --tb=short

  # Test C/C++ language server (clangd)
  test-clangd:
    name: Test C/C++ Language Server (clangd)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run clangd LSP tests
        run: |
          pytest tests/multilspy/test_*clangd*.py -v --tb=short

  # Test C# language server (OmniSharp) - tests are marked as skipped
  test-csharp:
    name: Test C# Language Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run C# LSP tests
        run: |
          pytest tests/multilspy/test_*csharp*.py -v --tb=short

  # Test sync timeout functionality
  test-sync-timeout:
    name: Test Sync Timeout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run sync timeout tests
        run: |
          pytest tests/multilspy/test_*timeout*.py -v --tb=short

  # Catch-all job to ensure no tests are silently skipped
  # This job finds any test files that don't match existing job patterns
  # and fails if such tests exist, alerting developers to add a dedicated job
  test-catch-all:
    name: Catch-All (Uncovered Tests)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Find uncovered test files
        id: find-uncovered
        run: |
          # Define patterns that are covered by existing jobs
          # These must match the patterns used in the test jobs above
          covered_patterns=(
            "python"
            "go"
            "ruby"
            "typescript"
            "javascript"
            "rust"
            "java"
            "kotlin"
            "dart"
            "clangd"
            "csharp"
            "timeout"
          )
          
          # Build grep pattern to exclude covered tests
          exclude_pattern=$(IFS="|"; echo "${covered_patterns[*]}")
          
          # Find all test files and filter out covered ones
          # Only match test_*.py files (not helper files like multilspy_context.py)
          uncovered_tests=$(find tests/multilspy -name "test_*.py" -type f | grep -vE "($exclude_pattern)" || true)
          
          if [[ -n "$uncovered_tests" ]]; then
            echo "Found uncovered test files:"
            echo "$uncovered_tests"
            echo "uncovered=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$uncovered_tests" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "All test files are covered by existing jobs."
            echo "uncovered=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.find-uncovered.outputs.uncovered == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: Install dependencies
        if: steps.find-uncovered.outputs.uncovered == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run uncovered tests
        if: steps.find-uncovered.outputs.uncovered == 'true'
        run: |
          echo "WARNING: The following test files are not covered by any dedicated test job:"
          echo "${{ steps.find-uncovered.outputs.files }}"
          echo ""
          echo "Please add a dedicated job for these tests in .github/workflows/test-workflow.yaml"
          echo "Running these tests with basic Python setup (they may fail if they require additional dependencies)..."
          echo ""
          pytest ${{ steps.find-uncovered.outputs.files }} -v --tb=short

      - name: Verify all tests are covered
        run: |
          # This step always runs to provide a clear message
          if [[ "${{ steps.find-uncovered.outputs.uncovered }}" == "true" ]]; then
            echo "::warning::Some test files are not covered by dedicated test jobs. Please add appropriate jobs for them."
          else
            echo "All test files are covered by dedicated test jobs."
          fi

  # Final job to check all tests passed
  all-tests-passed:
    name: All Tests Passed
    needs:
      - test-python
      - test-go
      - test-ruby
      - test-typescript-javascript
      - test-rust
      - test-java
      - test-kotlin
      - test-dart
      - test-clangd
      - test-csharp
      - test-sync-timeout
      - test-catch-all
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all tests passed
        run: |
          results=(
            "${{ needs.test-python.result }}"
            "${{ needs.test-go.result }}"
            "${{ needs.test-ruby.result }}"
            "${{ needs.test-typescript-javascript.result }}"
            "${{ needs.test-rust.result }}"
            "${{ needs.test-java.result }}"
            "${{ needs.test-kotlin.result }}"
            "${{ needs.test-dart.result }}"
            "${{ needs.test-clangd.result }}"
            "${{ needs.test-csharp.result }}"
            "${{ needs.test-sync-timeout.result }}"
            "${{ needs.test-catch-all.result }}"
          )
          
          failed=0
          for result in "${results[@]}"; do
            if [[ "$result" != "success" ]]; then
              failed=1
              break
            fi
          done
          
          if [[ $failed -eq 1 ]]; then
            echo "One or more test jobs failed!"
            exit 1
          fi
          echo "All tests passed!"
